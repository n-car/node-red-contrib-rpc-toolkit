<script type="text/javascript">
    RED.nodes.registerType('rpc-method', {
        category: 'network',
        color: '#3FADB5',
        defaults: {
            name: { value: "" },
            server: { value: "", type: "rpc-server", required: true },
            methodName: { value: "", required: true },
            schema: { value: "" },
            validateSchema: { value: false }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["request", "error"],
        icon: "function.svg",
        label: function() {
            return this.name || `method: ${this.methodName}`;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            const node = this;
            
            // Initialize schema editor with JSON type
            $('#node-input-schema').typedInput({
                type: 'json',
                types: ['json']
            });
            
            // Set initial value if exists
            if (node.schema) {
                $('#node-input-schema').typedInput('value', node.schema);
            } else {
                // Default schema template
                const defaultSchema = {
                    type: "object",
                    properties: {
                        param1: { type: "string" },
                        param2: { type: "number" }
                    },
                    required: ["param1"]
                };
                $('#node-input-schema').typedInput('value', JSON.stringify(defaultSchema, null, 2));
            }
            
            const toggleSchema = function() {
                if ($('#node-input-validateSchema').is(':checked')) {
                    $('#schema-row').show();
                } else {
                    $('#schema-row').hide();
                }
            };
            
            $('#node-input-validateSchema').on('change', toggleSchema);
            toggleSchema();
        },
        oneditsave: function() {
            // Get value from typedInput
            this.schema = $('#node-input-schema').typedInput('value');
        }
    });
</script>

<script type="text/html" data-template-name="rpc-method">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> RPC Server</label>
        <input type="text" id="node-input-server">
    </div>
    
    <div class="form-row">
        <label for="node-input-methodName"><i class="fa fa-code"></i> Method Name</label>
        <input type="text" id="node-input-methodName" placeholder="myMethod">
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-validateSchema" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-validateSchema" style="width:70%">Validate Schema</label>
    </div>
    
    <div class="form-row" id="schema-row" style="display:none;">
        <label for="node-input-schema" style="vertical-align:top;"><i class="fa fa-list-alt"></i> Schema</label>
        <input type="text" id="node-input-schema" style="width:70%;">
        <div class="form-tips" style="margin-left:100px;">JSON Schema (Draft 7) for parameter validation. Click the button to open the JSON editor.</div>
    </div>
</script>

<script type="text/html" data-help-name="rpc-method">
    <p>Registers a method handler in an RPC server.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>RPC Server <span class="property-type">rpc-server</span></dt>
        <dd>The RPC server node to register this method with</dd>
        
        <dt>Method Name <span class="property-type">string</span></dt>
        <dd>The name of the method to register</dd>
        
        <dt>Validate Schema <span class="property-type">boolean</span></dt>
        <dd>Enable parameter validation with JSON Schema</dd>
        
        <dt class="optional">Schema <span class="property-type">object</span></dt>
        <dd>JSON Schema (Draft 7) for validating method parameters. Requests with invalid parameters will be rejected with error code -32602.</dd>
    </dl>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">any</span></dt>
        <dd>The result to return to the caller</dd>
        
        <dt>rpc.id <span class="property-type">string</span></dt>
        <dd>Request ID (automatically passed through)</dd>
        
        <dt class="optional">error <span class="property-type">object</span></dt>
        <dd>Error to return to caller (will also output to error port)</dd>
    </dl>
    
    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Request
            <dl class="message-properties">
                <dt>payload <span class="property-type">object</span></dt>
                <dd>The method parameters from the RPC request</dd>
                
                <dt>rpc.method <span class="property-type">string</span></dt>
                <dd>The method name that was called</dd>
                
                <dt>rpc.id <span class="property-type">string</span></dt>
                <dd>Request ID to track the response</dd>
            </dl>
        </li>
        <li>Error
            <dl class="message-properties">
                <dt>error <span class="property-type">object</span></dt>
                <dd>Error object when processing fails</dd>
            </dl>
        </li>
    </ol>
    
    <h3>Details</h3>
    <p>This node registers a method in an RPC server. When the method is called:</p>
    <ol>
        <li>Parameters are sent to <strong>output 1</strong> (request port)</li>
        <li>Process them in your flow</li>
        <li>Send the result back to this node's <strong>input</strong></li>
        <li>If an error occurs, it will also be sent to <strong>output 2</strong> (error port)</li>
    </ol>
    
    <h3>Example Flow</h3>
    <pre>[RPC Method: "add"]
  ↓ (output 1)
[Function: a + b]
  ↓
[back to RPC Method input]
  → Response sent to caller
  
If error:
  ↓ (output 2)
[Error Handler]</pre>
</script>
