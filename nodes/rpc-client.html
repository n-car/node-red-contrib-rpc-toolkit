<script type="text/javascript">
    RED.nodes.registerType('rpc-client', {
        category: 'network',
        color: '#3FADB5',
        defaults: {
            name: { value: "" },
            serverUrl: { value: "", required: true },
            method: { value: "", required: true },
            timeout: { value: 5000, validate: RED.validators.number() },
            safeEnabled: { value: false },
            authToken: { value: "" }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["success", "error"],
        icon: "white-globe.svg",
        label: function() {
            return this.name || `rpc: ${this.method}`;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            const node = this;
            
            // Load methods button handler
            $('#node-input-load-methods').click(function() {
                const serverUrl = $('#node-input-serverUrl').val();
                if (!serverUrl) {
                    RED.notify('Please enter a server URL first', 'warning');
                    return;
                }
                
                $('#node-input-load-methods').prop('disabled', true).text('Loading...');
                
                // Try to call __rpc.listMethods
                fetch(serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: '__rpc.listMethods',
                        params: {},
                        id: Date.now()
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.result && Array.isArray(data.result)) {
                        const select = $('#node-input-method-select');
                        select.empty();
                        select.append('<option value="">-- Select a method --</option>');
                        data.result.forEach(method => {
                            select.append(`<option value="${method}">${method}</option>`);
                        });
                        select.show();
                        $('#node-input-method').hide();
                        RED.notify(`Loaded ${data.result.length} methods`, 'success');
                    } else {
                        RED.notify('Server does not support introspection or returned invalid data', 'warning');
                    }
                })
                .catch(err => {
                    RED.notify('Failed to load methods: ' + err.message, 'error');
                })
                .finally(() => {
                    $('#node-input-load-methods').prop('disabled', false).text('Load Methods');
                });
            });
            
            // Method select change handler
            $('#node-input-method-select').change(function() {
                const selected = $(this).val();
                if (selected) {
                    $('#node-input-method').val(selected);
                }
            });
            
            // Manual input button
            $('#node-input-manual-method').click(function() {
                $('#node-input-method-select').hide();
                $('#node-input-method').show();
            });
            
            // Initialize with current value
            if (node.method) {
                $('#node-input-method').show();
                $('#node-input-method-select').hide();
            }
        }
    });
</script>

<script type="text/html" data-template-name="rpc-client">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-serverUrl"><i class="fa fa-server"></i> Server URL</label>
        <input type="text" id="node-input-serverUrl" placeholder="http://localhost:3000/rpc">
    </div>
    
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-code"></i> Method</label>
        <div style="display: inline-block; width: 70%;">
            <select id="node-input-method-select" style="width: 100%; display: none;"></select>
            <input type="text" id="node-input-method" placeholder="methodName" style="width: 100%;">
        </div>
        <button type="button" id="node-input-load-methods" class="red-ui-button" style="margin-left: 5px;">
            <i class="fa fa-refresh"></i> Load Methods
        </button>
        <button type="button" id="node-input-manual-method" class="red-ui-button" style="margin-left: 5px; display: none;" title="Enter method manually">
            <i class="fa fa-keyboard-o"></i>
        </button>
    </div>
    
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> Timeout (ms)</label>
        <input type="number" id="node-input-timeout" placeholder="5000">
    </div>
    
    <div class="form-row">
        <label for="node-input-authToken"><i class="fa fa-key"></i> Auth Token</label>
        <input type="text" id="node-input-authToken" placeholder="Optional">
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-safeEnabled" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-safeEnabled" style="width:70%">Enable Safe Mode</label>
    </div>
</script>

<script type="text/html" data-help-name="rpc-client">
    <p>Calls a remote JSON-RPC 2.0 server method.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Server URL <span class="property-type">string</span></dt>
        <dd>The full URL of the RPC server endpoint</dd>
        
        <dt>Method <span class="property-type">string</span></dt>
        <dd>The RPC method name to call</dd>
        
        <dt>Timeout <span class="property-type">number</span></dt>
        <dd>Request timeout in milliseconds (default: 5000)</dd>
    </dl>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Method parameters as an object</dd>
        
        <dt class="optional">method <span class="property-type">string</span></dt>
        <dd>Override the configured method name</dd>
    </dl>
    
    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Success
            <dl class="message-properties">
                <dt>payload <span class="property-type">any</span></dt>
                <dd>The result from the RPC call</dd>
                
                <dt>rpc <span class="property-type">object</span></dt>
                <dd>RPC metadata (method, success: true)</dd>
            </dl>
        </li>
        <li>Error
            <dl class="message-properties">
                <dt>payload <span class="property-type">null</span></dt>
                <dd>Always null on error</dd>
                
                <dt>error <span class="property-type">object</span></dt>
                <dd>Error information (message, code)</dd>
            </dl>
        </li>
    </ol>
    
    <h3>Details</h3>
    <p>This node makes JSON-RPC 2.0 calls to remote servers.</p>
    <p>On success, the result is sent to <strong>output 1</strong>.</p>
    <p>On error, the error details are sent to <strong>output 2</strong>.</p>
    <p>Compatible with Express, PHP, .NET, and Arduino RPC servers.</p>
    
    <h3>Examples</h3>
    <p>Call an Arduino temperature sensor:</p>
    <pre>msg.payload = {}; // No parameters
// Output: msg.payload = 25.5</pre>
    
    <p>Call a PHP API with parameters:</p>
    <pre>msg.payload = { userId: 123 };
// Output: msg.payload = { name: "John", ... }</pre>
</script>
